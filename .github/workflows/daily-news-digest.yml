name: 🤖 AI-Powered Daily News Digest & Website

on:
  schedule:
    # Run daily at 5:00 AM UTC (6:00 AM BST / 5:00 AM GMT)
    # This ensures 6 AM UK time during British Summer Time
    - cron: '0 5 * * *'
  workflow_dispatch: # Allow manual triggering
    inputs:
      debug_mode:
        description: 'Enable debug output'
        required: false
        default: 'false'
        type: boolean
      force_ai_regeneration:
        description: 'Force AI analysis even if today content exists (costs API credits)'
        required: false
        default: 'false'
        type: boolean
      deploy_only:
        description: 'Skip AI generation, just redeploy existing content'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-ai-digest:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      actions: read
      issues: write  # For creating issues on failures
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 🐍 Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install openai anthropic  # Multiple AI providers
    
    - name: 🔍 Check if today's content exists
      id: check_content
      run: |
        TODAY=$(date +%Y_%m_%d)
        AUDIO_FILE="news_digest_ai_${TODAY}.mp3"
        TEXT_FILE="news_digest_ai_${TODAY}.txt"
        
        if [[ -f "$AUDIO_FILE" && -f "$TEXT_FILE" ]]; then
          echo "content_exists=true" >> $GITHUB_OUTPUT
          echo "✅ Today's content already exists: $AUDIO_FILE, $TEXT_FILE"
        else
          echo "content_exists=false" >> $GITHUB_OUTPUT
          echo "❌ Today's content missing - will generate new content"
        fi
        
        echo "today_date=$TODAY" >> $GITHUB_OUTPUT
    
    - name: 🤖 Generate AI-Enhanced News Digest
      # Only run AI generation if content doesn't exist OR forced regeneration OR not deploy-only
      if: steps.check_content.outputs.content_exists == 'false' || inputs.force_ai_regeneration == 'true' || (inputs.deploy_only != 'true' && github.event_name == 'schedule')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
      run: |
        echo "🚀 Starting AI-enhanced news digest generation..."
        echo "💰 This step uses API credits - content_exists: ${{ steps.check_content.outputs.content_exists }}"
        python github_ai_news_digest.py
        echo "✅ Digest generation completed"
    
    - name: ⚡ Skip AI Generation (Cost Optimization)
      if: steps.check_content.outputs.content_exists == 'true' && inputs.force_ai_regeneration != 'true' && inputs.deploy_only == 'true'
      run: |
        echo "💰 COST OPTIMIZATION: Skipping AI generation"
        echo "✅ Today's content already exists: ${{ steps.check_content.outputs.today_date }}"
        echo "🔄 Will redeploy existing content with UX improvements"
    
    - name: 📊 Analyze generated content
      run: |
        if [ -f news_digest_ai_*.mp3 ]; then
          echo "🎧 Audio file generated successfully"
          ls -lh news_digest_ai_*.mp3
        fi
        if [ -f news_digest_ai_*.txt ]; then
          echo "📄 Text file generated successfully"
          wc -w news_digest_ai_*.txt
        fi
    
    - name: 🌐 Update website with new content
      run: |
        echo "🌐 Updating accessible newspaper website..."
        python update_website.py
        echo "✅ Website updated with today's digest"
    
    - name: 📱 Copy audio files to website
      run: |
        # Ensure audio directory exists
        mkdir -p docs/audio
        
        # Copy new audio and text files
        cp news_digest_ai_*.mp3 docs/audio/ 2>/dev/null || echo "No new audio files"
        cp news_digest_ai_*.txt docs/ 2>/dev/null || echo "No new text files"
        
        # List what we have
        echo "📁 Website audio files:"
        ls -la docs/audio/ || echo "Audio directory empty"
    
    - name: 🔍 Quality check
      run: |
        # Check if files were generated
        if [ ! -f news_digest_ai_*.mp3 ]; then
          echo "❌ No audio file generated"
          exit 1
        fi
        
        # Check audio file size (should be > 100KB for meaningful content)
        audio_size=$(stat -c%s news_digest_ai_*.mp3)
        if [ $audio_size -lt 100000 ]; then
          echo "⚠️ Audio file seems too small: ${audio_size} bytes"
        else
          echo "✅ Audio file size OK: ${audio_size} bytes"
        fi
        
        # Check if website was updated
        if [ ! -f docs/index.html ]; then
          echo "❌ Website index.html missing"
          exit 1
        fi
        
        echo "✅ Quality checks passed"
    
    - name: 📝 Commit generated files
      run: |
        git config --local user.email "ai-digest@github.com"
        git config --local user.name "AI News Digest Bot"
        
        # Add generated files
        git add news_digest_ai_*.mp3 news_digest_ai_*.txt docs/ || true
        
        # Create commit with date and stats
        if git diff --staged --quiet; then
          echo "No new files to commit"
        else
          audio_file=$(ls news_digest_ai_*.mp3)
          audio_size=$(stat -c%s "$audio_file" | numfmt --to=iec)
          git commit -m "🤖 Daily AI news digest & website update $(date +%Y-%m-%d)

          📊 Generated: $(date '+%Y-%m-%d %H:%M UTC')
          🎧 Audio: ${audio_size}
          🤖 AI: Enhanced analysis
          🌐 Website: Updated with accessible newspaper layout
          ♿ Accessibility: Optimized for visually impaired users"
          
          git push
          echo "✅ Files committed and pushed successfully"
        fi
    
    - name: 📤 Upload artifacts for download
      uses: actions/upload-artifact@v4
      with:
        name: ai-news-digest-${{ github.run_number }}
        path: |
          news_digest_ai_*.mp3
          news_digest_ai_*.txt
          docs/
        retention-days: 90
    
    - name: 🏷️ Create release for audio file
      if: success()
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: daily-${{ github.run_number }}
        name: 🎧 Daily AI News Digest - ${{ github.run_number }}
        body: |
          🤖 **AI-Enhanced News Digest**
          📅 Generated: ${{ github.event.head_commit.timestamp }}
          
          ### 🎯 Features
          - ✅ Claude 4.5 Sonnet AI analysis
          - ✅ Multi-source UK news synthesis  
          - ✅ Irish Emily Neural voice (premium quality)
          - ✅ WhatsApp-ready MP3 format
          - ✅ Copyright-compliant synthesis
          - ✅ Accessible newspaper website
          
                 ### 📥 Access Options
                 - **🌐 Website**: [Daily News Digest](https://audionews.uk)
                 - **Audio**: `news_digest_ai_*.mp3` - Ready for WhatsApp sharing
          - **Text**: `news_digest_ai_*.txt` - Full transcript with sources
          
          Perfect for visually impaired users! 🎧♿
        draft: false
        prerelease: false
        files: |
          news_digest_ai_*.mp3
          news_digest_ai_*.txt
    
    - name: ❌ Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `🚨 Daily AI Digest Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `### ❌ AI News Digest Generation Failed
            
            **Run**: ${context.runId}
            **Date**: ${new Date().toISOString()}
            **Workflow**: ${context.workflow}
            
            Please check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.
            
            ### Possible Issues:
            - API key expired or missing
            - Network connectivity issues
            - News source changes
            - Audio generation failure
            - Website update failure
            
            This needs immediate attention for accessibility service continuity.`,
            labels: ['bug', 'ai-digest', 'urgent']
          })

  deploy-website:
    needs: generate-ai-digest
    runs-on: ubuntu-latest
    if: success()
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: 📥 Checkout repository  
      uses: actions/checkout@v4
      with:
        ref: main  # Get the latest commit with updates
    
    - name: 🔧 Setup Pages
      uses: actions/configure-pages@v5
    
    - name: 📦 Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./docs
    
    - name: 🚀 Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  notify-completion:
    needs: [generate-ai-digest, deploy-website]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: 🎉 Success notification
      run: |
        echo "🎉 Daily AI news digest generated successfully!"
        echo "📅 Date: $(date)"
        echo "🎧 Audio ready for visually impaired users"
        echo "🤖 AI analysis completed"
        echo "🌐 Accessible website deployed"
        echo "♿ Accessibility service operational"
        echo ""
               echo "🔗 Website: https://audionews.uk"
