<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioNews - Daily Voice News Digest</title>
    <meta name="description" content="Daily AI-generated audio news digest. Professional voice, screen reader optimized, available in multiple languages.">
    <meta name="keywords" content="audio news, voice news, daily news digest, accessible news, multilingual news, UK news, French news, German news">
    
    <!-- SEO Meta Tags -->
    <meta name="author" content="Dynamic Devices">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://audionews.uk/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://audionews.uk/">
    <meta property="og:title" content="AudioNews - Daily Voice News Digest">
    <meta property="og:description" content="Daily AI-generated audio news digest in multiple languages">
    <meta property="og:image" content="https://audionews.uk/shared/images/social-card.png">
    <meta property="og:site_name" content="AudioNews">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://audionews.uk/">
    <meta property="twitter:title" content="AudioNews - Daily Voice News Digest">
    <meta property="twitter:description" content="Daily AI-generated audio news digest in multiple languages">
    <meta property="twitter:image" content="https://audionews.uk/shared/images/social-card.png">
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a365d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AudioNews">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E📰%3C/text%3E%3C/svg%3E">
    
    <!-- Critical CSS -->
    <style>
        /* Critical styles for immediate rendering */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: #f8fafc;
            color: #2d3748;
        }
        
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #1a365d;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 1000;
            border-radius: 0 0 4px 4px;
        }
        
        .skip-link:focus {
            top: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .tagline {
            margin: 0.5rem 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .language-selector {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .lang-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .lang-btn:hover, .lang-btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
        }
        
        .lang-btn.active {
            background: rgba(255, 255, 255, 0.4);
            font-weight: 600;
        }
        
        /* Loading state */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #718096;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #3182ce;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Content area */
        .content {
            min-height: 60vh;
            padding: 2rem 0;
        }
        
        /* Hide content initially */
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
    </style>
    
    <!-- Load full CSS asynchronously -->
    <link rel="preload" href="shared/css/newspaper.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="shared/css/newspaper.css"></noscript>
</head>
<body>
    <!-- Skip to main content link for screen readers -->
    <a href="#main-content" class="skip-link" data-i18n="skip_link">Skip to main content</a>
    
    <!-- Header -->
    <header class="site-header" role="banner">
        <div class="header-container" style="text-align: center;">
            <h1 class="site-title">
                <span class="site-icon" aria-hidden="true" id="site-flag">📰</span>
                <span id="site-name">AudioNews</span>
            </h1>
            <p class="site-tagline" id="site-tagline">Brought to you by Dynamic Devices</p>
            
            <!-- Language Selector -->
            <div class="language-selector" role="navigation" aria-label="Language selection">
                <button class="lang-btn active" data-lang="en_GB" aria-label="English (UK)">
                    🇬🇧 English
                </button>
                <button class="lang-btn" data-lang="fr_FR" aria-label="Français (France)">
                    🇫🇷 Français
                </button>
                <button class="lang-btn" data-lang="de_DE" aria-label="Deutsch (Deutschland)">
                    🇩🇪 Deutsch
                </button>
            </div>
        </div>
    </header>

    <!-- Main content area -->
    <main id="main-content" class="main-content" role="main">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p data-i18n="loading">Loading your personalized news digest...</p>
        </div>
        
        <!-- Content will be dynamically loaded here -->
        <div id="content-container"></div>
    </main>

    <!-- Footer -->
    <footer class="site-footer" role="contentinfo">
        <div class="footer-container" style="text-align: center;">
            <p class="copyright" id="footer-text">
                © 2025 Dynamic Devices • 
                <a href="https://github.com/DynamicDevices/daily-voice-news" class="footer-link">Open Source on GitHub</a> • 
                Made with ♿ accessibility in mind
            </p>
        </div>
    </footer>
    
    <!-- JavaScript -->
    <script src="shared/js/accessibility.js" defer></script>
    
    <!-- Multi-language App Logic -->
    <script>
        class AudioNewsApp {
            constructor() {
                this.currentLanguage = 'en_GB';
                this.languages = {};
                this.contentCache = {};
                this.init();
            }
            
            async init() {
                // Detect user's preferred language
                await this.detectLanguage();
                
                // Load language configurations
                await this.loadLanguageConfigs();
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Load initial content
                await this.loadContent(this.currentLanguage);
            }
            
            async detectLanguage() {
                try {
                    // Check URL parameter first
                    const urlParams = new URLSearchParams(window.location.search);
                    const langParam = urlParams.get('lang');
                    if (langParam && ['en_GB', 'fr_FR', 'de_DE'].includes(langParam)) {
                        this.currentLanguage = langParam;
                        return;
                    }
                    
                    // Check localStorage
                    const savedLang = localStorage.getItem('audioNewsLanguage');
                    if (savedLang && ['en_GB', 'fr_FR', 'de_DE'].includes(savedLang)) {
                        this.currentLanguage = savedLang;
                        return;
                    }
                    
                    // Auto-detect based on location (optional)
                    try {
                        const response = await fetch('https://ipapi.co/json/');
                        const data = await response.json();
                        
                        if (data.country_code === 'GB') {
                            this.currentLanguage = 'en_GB';
                        } else if (data.country_code === 'FR') {
                            this.currentLanguage = 'fr_FR';
                        } else if (data.country_code === 'DE') {
                            this.currentLanguage = 'de_DE';
                        }
                        // Default to en_GB for other countries
                    } catch (e) {
                        console.log('Location detection failed, using default language');
                    }
                } catch (e) {
                    console.log('Language detection failed, using default');
                }
            }
            
            async loadLanguageConfigs() {
                const languages = ['en_GB', 'fr_FR', 'de_DE'];
                for (const lang of languages) {
                    try {
                        const response = await fetch(`config/languages/${lang}.json`);
                        this.languages[lang] = await response.json();
                    } catch (e) {
                        console.error(`Failed to load ${lang} config:`, e);
                    }
                }
            }
            
            setupEventListeners() {
                // Language selector buttons
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const lang = e.target.dataset.lang;
                        this.switchLanguage(lang);
                    });
                });
            }
            
            async switchLanguage(language) {
                if (language === this.currentLanguage) return;
                
                this.currentLanguage = language;
                
                // Save preference
                localStorage.setItem('audioNewsLanguage', language);
                
                // Update URL without reload
                const url = new URL(window.location);
                url.searchParams.set('lang', language);
                window.history.replaceState({}, '', url);
                
                // Update UI
                this.updateLanguageSelector();
                await this.loadContent(language);
            }
            
            updateLanguageSelector() {
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.lang === this.currentLanguage);
                });
            }
            
            async loadContent(language) {
                const loading = document.getElementById('loading');
                const container = document.getElementById('content-container');
                
                // Show loading
                loading.style.display = 'block';
                container.innerHTML = '';
                
                try {
                    // Load content from cache or fetch
                    let content = this.contentCache[language];
                    if (!content) {
                        content = await this.fetchContent(language);
                        this.contentCache[language] = content;
                    }
                    
                    // Update page metadata
                    this.updatePageMetadata(language);
                    
                    // Render content
                    container.innerHTML = content;
                    
                    // Initialize audio player and other interactive elements
                    this.initializeInteractiveElements();
                    
                } catch (e) {
                    console.error('Failed to load content:', e);
                    container.innerHTML = `
                        <div class="container">
                            <div class="error-message">
                                <h2>⚠️ Content Loading Error</h2>
                                <p>Unable to load content for this language. Please try again later.</p>
                                <button onclick="location.reload()" class="action-button">Reload Page</button>
                            </div>
                        </div>
                    `;
                } finally {
                    loading.style.display = 'none';
                }
            }
            
            async fetchContent(language) {
                // Try to load from language-specific directory first
                const paths = [
                    `${language}/content.html`,
                    `config/content/${language}.html`
                ];
                
                for (const path of paths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            return await response.text();
                        }
                    } catch (e) {
                        continue;
                    }
                }
                
                // Fallback: generate content dynamically
                return this.generateContent(language);
            }
            
            generateContent(language) {
                const config = this.languages[language];
                if (!config) {
                    throw new Error(`No configuration found for ${language}`);
                }
                
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '_');
                const audioFile = `${language}/audio/news_digest_ai_${today}.mp3`;
                
                return `
                    <!-- Today's audio digest -->
                    <section id="todays-digest" class="featured-digest" aria-labelledby="todays-heading">
                        <header class="section-header">
                            <h2 id="todays-heading" class="section-title">
                                <span class="section-icon" aria-hidden="true">🎧</span>
                                ${config.sections.todays_digest.title}
                            </h2>
                            <p class="section-description">${config.sections.todays_digest.description}</p>
                        </header>
                        
                        <article class="digest-card main-digest">
                            <header class="digest-header">
                                <h3 class="digest-title">
                                    <time datetime="${today.replace(/_/g, '-')}" class="digest-date">${this.formatDate(today, language)}</time>
                                    - ${config.site.name} Summary
                                </h3>
                            </header>
                            
                            <!-- Accessible audio player -->
                            <div class="audio-player-container">
                                <audio 
                                    class="audio-player" 
                                    controls 
                                    preload="auto"
                                    crossorigin="anonymous"
                                    aria-describedby="audio-description"
                                    id="news-audio"
                                >
                                    <source src="${audioFile}" type="audio/mpeg">
                                    ${config.audio.fallback.replace('{{AUDIO_FILE}}', audioFile)}
                                </audio>
                                
                                <p id="audio-description" class="audio-description">
                                    ${config.audio.description}
                                </p>
                            </div>
                            
                            <!-- Download and sharing options -->
                            <div class="digest-actions">
                                <a href="${audioFile}" 
                                   download="news_digest_ai_${today}.mp3" 
                                   class="action-btn download-btn"
                                   aria-describedby="download-help">
                                    <span class="btn-icon" aria-hidden="true">📱</span>
                                    ${config.audio.download_button}
                                </a>
                                
                                <button id="copy-share-link" 
                                        class="action-btn share-btn"
                                        aria-describedby="share-help">
                                    <span class="btn-icon" aria-hidden="true">🔗</span>
                                    ${config.audio.share_button}
                                </button>
                            </div>
                            
                            <div class="help-text">
                                <p id="download-help" class="help-item">
                                    <strong>📱 ${config.audio.download_button}:</strong> ${config.audio.download_help}
                                </p>
                                <p id="share-help" class="help-item">
                                    <strong>🔗 ${config.audio.share_button}:</strong> ${config.audio.share_help}
                                </p>
                            </div>
                        </article>
                    </section>
                    
                    <!-- About this service -->
                    <section id="about-service" class="about-service" aria-labelledby="about-heading">
                        <header class="section-header">
                            <h2 id="about-heading" class="section-title">
                                <span class="section-icon" aria-hidden="true">💡</span>
                                ${config.sections.about.title}
                            </h2>
                        </header>
                        
                        <div class="instructions">
                            <div class="instruction-group">
                                <h3 class="instruction-title">${config.about_content.what_you_get.title}</h3>
                                <ul class="instruction-list">
                                    ${config.about_content.what_you_get.items.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div class="instruction-group">
                                <h3 class="instruction-title">${config.about_content.accessibility.title}</h3>
                                <ul class="instruction-list">
                                    ${config.about_content.accessibility.items.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div class="instruction-group">
                                <h3 class="instruction-title">${config.about_content.contact.title}</h3>
                                <ul class="instruction-list">
                                    ${config.about_content.contact.items.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                            
                            ${config.about_content.development_status ? `
                            <div class="instruction-group development-notice">
                                <h3 class="instruction-title">${config.about_content.development_status.title}</h3>
                                <ul class="instruction-list">
                                    ${config.about_content.development_status.items.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                    </section>
                `;
            }
            
            updatePageMetadata(language) {
                const config = this.languages[language];
                if (!config) return;
                
                // Update page title
                document.title = config.page.title.replace('{{DATE}}', this.formatDate(new Date().toISOString().split('T')[0], language));
                
                // Update meta description
                const metaDesc = document.querySelector('meta[name="description"]');
                if (metaDesc) {
                    metaDesc.content = config.page.description.replace('{{DATE}}', this.formatDate(new Date().toISOString().split('T')[0], language));
                }
                
                // Update header
                document.getElementById('site-flag').textContent = config.site.flag;
                document.getElementById('site-name').textContent = config.site.name;
                document.getElementById('site-tagline').textContent = config.site.tagline;
                
                // Update footer
                document.getElementById('footer-text').innerHTML = config.footer.copyright;
                
                // Update HTML lang attribute
                document.documentElement.lang = config.language_code;
            }
            
            formatDate(dateStr, language) {
                // dateStr is in format YYYY_MM_DD, convert to YYYY-MM-DD for Date constructor
                const isoDateStr = dateStr.replace(/_/g, '-');
                const date = new Date(isoDateStr + 'T00:00:00');
                
                if (language === 'en_GB') {
                    return date.toLocaleDateString('en-GB', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                } else if (language === 'fr_FR') {
                    return date.toLocaleDateString('fr-FR', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                } else if (language === 'de_DE') {
                    return date.toLocaleDateString('de-DE', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                }
                
                return dateStr;
            }
            
            initializeInteractiveElements() {
                // Copy to clipboard functionality
                const copyButton = document.getElementById('copy-share-link');
                if (copyButton) {
                    copyButton.addEventListener('click', async () => {
                        const config = this.languages[this.currentLanguage];
                        const shareUrl = window.location.origin + window.location.pathname + '?autoplay=1&lang=' + this.currentLanguage;
                        
                        try {
                            await navigator.clipboard.writeText(shareUrl);
                            
                            const originalText = copyButton.textContent;
                            copyButton.textContent = '✅ ' + config.javascript.copy_success;
                            copyButton.style.background = '#48bb78';
                            
                            setTimeout(() => {
                                copyButton.textContent = originalText;
                                copyButton.style.background = '';
                            }, 2000);
                            
                        } catch (err) {
                            alert(config.javascript.copy_error + shareUrl);
                        }
                    });
                }
                
                // Auto-play functionality
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('autoplay') === '1') {
                    const audioElement = document.getElementById('news-audio');
                    if (audioElement) {
                        setTimeout(() => {
                            audioElement.play().catch(e => {
                                console.log('Auto-play prevented by browser policy');
                            });
                        }, 500);
                    }
                }
            }
        }
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new AudioNewsApp();
        });
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('✅ ServiceWorker registered successfully:', registration.scope);
                    }, function(err) {
                        console.log('❌ ServiceWorker registration failed:', err);
                    });
            });
        }
    </script>
</body>
</html>